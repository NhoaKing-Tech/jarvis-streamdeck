<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<meta name="generator" content="pdoc3 0.11.6">
<title>run_jarvis API documentation</title>
<meta name="description" content="NAME: run_jarvis.py
DESCRIPTION: Python script to run my stream deck XL with custom icons and actions.
AUTHOR: NhoaKing (pseudonym for privacy)
FINISH DATE: September 14th â€¦">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/sanitize.min.css" integrity="sha512-y1dtMcuvtTMJc1yPgEqF0ZjQbhnc/bFhyvIyVNb9Zk5mIGtqVaAB1Ttl28su8AvFMOY0EwRbAe+HCLqj6W7/KA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/13.0.0/typography.min.css" integrity="sha512-Y1DYSb995BAfxobCkKepB1BqJJTPrOp3zPL74AWFugHHmmdcvO+C48WLrUOlhGMc0QG7AE3f7gmvvcrmX2fDoA==" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:1.5em;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:2em 0 .50em 0}h3{font-size:1.4em;margin:1.6em 0 .7em 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .2s ease-in-out}a:visited{color:#503}a:hover{color:#b62}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900;font-weight:bold}pre code{font-size:.8em;line-height:1.4em;padding:1em;display:block}code{background:#f3f3f3;font-family:"DejaVu Sans Mono",monospace;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source > summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible;min-width:max-content}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em 1em;margin:1em 0}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul ul{padding-left:1em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => {
hljs.configure({languages: ['bash', 'css', 'diff', 'graphql', 'ini', 'javascript', 'json', 'plaintext', 'python', 'python-repl', 'rust', 'shell', 'sql', 'typescript', 'xml', 'yaml']});
hljs.highlightAll();
/* Collapse source docstrings */
setTimeout(() => {
[...document.querySelectorAll('.hljs.language-python > .hljs-string')]
.filter(el => el.innerHTML.length > 200 && ['"""', "'''"].includes(el.innerHTML.substring(0, 3)))
.forEach(el => {
let d = document.createElement('details');
d.classList.add('hljs-string');
d.innerHTML = '<summary>"""</summary>' + el.innerHTML.substring(3);
el.replaceWith(d);
});
}, 100);
})</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>run_jarvis</code></h1>
</header>
<section id="section-intro">
<p>NAME: run_jarvis.py
DESCRIPTION: Python script to run my stream deck XL with custom icons and actions.
AUTHOR: NhoaKing (pseudonym for privacy)
FINISH DATE: September 14th 2025 (Sunday)
NOTE: IMPORTANT TO EXECUTE THIS SCRIPT FROM LINUX TERMINAL, AND NOT FROM THE VSCODE TERMINAL, AS THE SYSTEM CALLS (ydotool, wmctrl, etc.) ARE NOT WORKING PROPERLY WHEN EXECUTED FROM VSCODE TERMINAL. IF WHEN TESTED FROM LINUX TERMINAL THE SCRIPT WORKS AS EXPECTED, THEN IT WILL WORK THE SAME WHEN EXECUTED FROM THE SYSTEM SERVICE.</p>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="run_jarvis.load_config"><code class="name flex">
<span>def <span class="ident">load_config</span></span>(<span>)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def load_config():
    &#34;&#34;&#34;Load environment variables from config.env file into os.environ.

    This function implements a simple .env file parser that reads environment
    variables from a config.env file and loads them into the current process
    environment. This approach allows for runtime configuration without
    hardcoding paths or credentials in the source code.

    Process:
        1. Reads the config.env file line by line
        2. Skips empty lines and comments (lines starting with #)
        3. Parses KEY=VALUE pairs and adds them to environment variables
        4. Gracefully handles missing config files

    Performance:
        This function is called once at startup, so the file I/O overhead is
        negligible. We could cache the results, but since this runs only once,
        caching would add complexity without meaningful benefit.

    Note:
        The config.env file should be located in the same directory as this script.
        Each line should follow the format: KEY=VALUE
    &#34;&#34;&#34;
    # Use pathlib for robust path handling - __file__ is the absolute path to this script
    config_path = Path(__file__).parent / &#34;config.env&#34;  # Looks for config.env in same directory as this script

    # Check if config file exists before trying to read it
    # This prevents FileNotFoundError and allows jarvis to run with default values
    if config_path.exists():
        # Open file with default UTF-8 encoding (Python 3 default)
        with open(config_path) as f:
            # Process each line in the config file
            for line in f:
                line = line.strip()  # Remove leading/trailing whitespace and newlines

                # Skip empty lines and comment lines (starting with #)
                # Also ensure line contains = sign for KEY=VALUE format
                if line and not line.startswith(&#39;#&#39;) and &#39;=&#39; in line:
                    # Split on first = only (in case value contains = characters)
                    # Example: &#34;DATABASE_URL=postgres://user:pass=123@host/db&#34;
                    key, value = line.split(&#39;=&#39;, 1)

                    # Strip whitespace from key and value, then add to environment
                    # os.environ is a dict-like object that interfaces with system environment
                    os.environ[key.strip()] = value.strip()</code></pre>
</details>
<div class="desc"><p>Load environment variables from config.env file into os.environ.</p>
<p>This function implements a simple .env file parser that reads environment
variables from a config.env file and loads them into the current process
environment. This approach allows for runtime configuration without
hardcoding paths or credentials in the source code.</p>
<h2 id="process">Process</h2>
<ol>
<li>Reads the config.env file line by line</li>
<li>Skips empty lines and comments (lines starting with #)</li>
<li>Parses KEY=VALUE pairs and adds them to environment variables</li>
<li>Gracefully handles missing config files</li>
</ol>
<h2 id="performance">Performance</h2>
<p>This function is called once at startup, so the file I/O overhead is
negligible. We could cache the results, but since this runs only once,
caching would add complexity without meaningful benefit.</p>
<h2 id="note">Note</h2>
<p>The config.env file should be located in the same directory as this script.
Each line should follow the format: KEY=VALUE</p></div>
</dd>
<dt id="run_jarvis.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>)</span>
</code></dt>
<dd>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main():
    &#34;&#34;&#34;Main entry point for the jarvis StreamDeck application.

    This function orchestrates the entire application startup process and handles
    the complete lifecycle of the StreamDeck integration. It implements a robust
    initialization sequence with retry logic for hardware discovery.

    Process:
        1. Initializes all modules with required configuration
        2. Discovers and connects to StreamDeck hardware with retry logic
        3. Sets up UI layouts and event handling
        4. Registers signal handlers for graceful shutdown
        5. Enters the main event loop

    Retry Mechanism:
        Uses a retry mechanism to handle temporary StreamDeck disconnections,
        USB timing issues, and device driver delays. Attempts connection for
        up to 5 minutes with 5-second intervals.

    Signal Handling:
        Registers handlers for SIGINT (Ctrl+C) and sets up atexit cleanup
        to ensure proper resource cleanup on exit.

    Raises:
        SystemExit: If StreamDeck hardware cannot be found after retry attempts
    &#34;&#34;&#34;
    # Declare global variables that will be modified in this function
    # Using globals here is necessary because StreamDeck callbacks need access to these
    global deck, current_layout, layouts

    # Initialize all jarvis modules with configuration data
    # This dependency injection pattern allows modules to be tested independently
    # and keeps configuration centralized in this main module

    # Initialize actions module with tool paths and directories
    # This provides actions.py with access to ydotool, snippet files, etc.
    actions.initialize_actions(YDOTOOL_PATH,
           SNIPPETS_DIR, BASHSCRIPTS_DIR, PROJECTS_DIR, KEYCODES, KEYRING_PW)

    # Initialize rendering module with fonts, icons, and user-specific paths
    # This provides ui/render.py with access to visual assets and configuration
    initialize_render(FONT_DIR, ICONS_DIR, USER_HOME, PROJECTS_DIR, OBSIDIAN_VAULTS, KEYRING_PW)

    # Initialize lifecycle management with cleanup tools
    # This provides ui/lifecycle.py with access to ydotool for key release
    initialize_lifecycle(YDOTOOL_PATH, KEYCODES)

    # StreamDeck Discovery and Connection with Retry Logic
    # This section implements a robust connection strategy to handle:
    # 1. StreamDeck not plugged in at startup
    # 2. USB connection issues
    # 3. Device driver delays
    # 4. Temporary hardware disconnections

    # Configuration for retry mechanism
    interval_seconds = 5  # Wait 5 seconds between connection attempts
    max_retry_minutes = 5  # Give up after 5 minutes of trying

    # Initialize deck variable - will hold the StreamDeck object once connected
    deck = None

    # Calculate maximum number of attempts based on time constraints

    max_tries = (max_retry_minutes * 60) / interval_seconds
    current_tries = 0

    # Main connection retry loop
    while current_tries &lt; max_tries:
        # Attempt to discover connected StreamDeck devices
        # DeviceManager().enumerate() scans USB devices for Elgato StreamDecks
        # This call may take a few hundred milliseconds as it queries USB devices
        decks = DeviceManager().enumerate()  # Returns list of StreamDeck device objects

        if decks:
            # At least one StreamDeck was found - use the first one
            # NOTE: This assumes only one StreamDeck is connected. For multiple devices,
            # we would need to identify them by serial number or model
            deck = decks[0]  # Get the first (and presumably only) StreamDeck
            # Uncommented debug print: print(&#34;Found connected stream deck&#34;)
            break  # Exit the retry loop immediately upon successful discovery
        else:
            # No StreamDeck found on this attempt - wait and try again
            # Uncommented debug print: print(f&#34;Stream deck not found, retrying in {interval_seconds} seconds...&#34;)
            time.sleep(interval_seconds)  # Non-blocking sleep - allows Ctrl+C to interrupt
            current_tries += 1  # Increment attempt counter
    else:
        # This else clause executes only if the while loop completed without breaking
        # (i.e., we exhausted all retry attempts without finding a StreamDeck)
        # Uncommented debug print: print(&#34;Stream Deck not found.&#34;)
        sys.exit(1)  # Exit with error code 1 to indicate failure

    # PERFORMANCE OPTIMIZATION OPPORTUNITY:
    # The retry loop could be improved by:
    # 1. Using exponential backoff (1s, 2s, 4s, 8s, then 5s intervals)
    # 2. Caching USB device enumeration results
    # 3. Adding signal handling to allow graceful exit during retry
    # However, given that this runs only once at startup and StreamDecks are
    # typically always connected, the current simple approach is adequate

    # StreamDeck Hardware Initialization
    # Now that we have a StreamDeck object, we need to open the USB connection
    # and prepare the device for use

    deck.open()   # Open USB communication channel to the StreamDeck device
    deck.reset()  # Clear any existing images/state from previous sessions
    # reset() turns off all key LEDs and clears any displayed images

    # UI Layout Initialization
    # Create all layout definitions now that deck hardware is available
    # Some layout functions need access to the deck object (e.g., for toggle_mic)
    layouts = create_layouts(deck)  # Returns dictionary of layout_name -&gt; layout_config

    # Initialize UI logic module with deck and layout state
    # This sets up the global state needed for key event handling
    initialize_logic(deck, layouts, &#34;main&#34;)  # &#34;main&#34; is the initial layout to display

    # Render the initial layout to the StreamDeck
    # This displays icons and sets up the visual state of all 32 keys
    render_layout(deck, layouts[current_layout])  # current_layout is &#34;main&#34; at startup

    # Event Handler Registration
    # Register our key_change function to be called whenever any key is pressed or released
    # The StreamDeck library will call key_change(deck, key_number, is_pressed) for each event
    deck.set_key_callback(key_change)  # key_change is imported from ui.logic module

    # Signal Handler Registration for Graceful Shutdown
    # Set up handlers to clean up resources when the program is interrupted or terminated

    # Handle Ctrl+C (SIGINT) signal with graceful shutdown
    # Lambda function ignores the signal number and frame arguments
    signal.signal(signal.SIGINT, lambda _s, _f: safe_exit(deck))
    # Alternative: signal.signal(signal.SIGINT, lambda *args: safe_exit(deck))

    # Register cleanup function to run automatically when Python interpreter exits
    # This handles cases where the program exits normally or due to exceptions
    atexit.register(cleanup, deck)  # cleanup function is imported from ui.lifecycle

    # Enter Main Event Loop
    # Print status message to let user know the application is running
    print(&#34;Stream deck script is running. Press CTRL+C to quit.&#34;)

    # Pause the main thread indefinitely, waiting for signals
    # signal.pause() blocks until a signal is received (like SIGINT from Ctrl+C)
    # All actual work happens in the key_change callback function on separate threads
    signal.pause()  # This is an efficient way to keep the program alive without busy-waiting

    # PERFORMANCE CONSIDERATION:
    # signal.pause() is much more efficient than alternatives like:
    # - while True: time.sleep(1)  # Uses unnecessary CPU cycles
    # - input(&#34;Press Enter to quit&#34;)  # Requires user interaction
    # - threading.Event().wait()  # More complex and unnecessary for this use case</code></pre>
</details>
<div class="desc"><p>Main entry point for the jarvis StreamDeck application.</p>
<p>This function orchestrates the entire application startup process and handles
the complete lifecycle of the StreamDeck integration. It implements a robust
initialization sequence with retry logic for hardware discovery.</p>
<h2 id="process">Process</h2>
<ol>
<li>Initializes all modules with required configuration</li>
<li>Discovers and connects to StreamDeck hardware with retry logic</li>
<li>Sets up UI layouts and event handling</li>
<li>Registers signal handlers for graceful shutdown</li>
<li>Enters the main event loop</li>
</ol>
<p>Retry Mechanism:
Uses a retry mechanism to handle temporary StreamDeck disconnections,
USB timing issues, and device driver delays. Attempts connection for
up to 5 minutes with 5-second intervals.</p>
<p>Signal Handling:
Registers handlers for SIGINT (Ctrl+C) and sets up atexit cleanup
to ensure proper resource cleanup on exit.</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>SystemExit</code></dt>
<dd>If StreamDeck hardware cannot be found after retry attempts</dd>
</dl></div>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="run_jarvis.load_config" href="#run_jarvis.load_config">load_config</a></code></li>
<li><code><a title="run_jarvis.main" href="#run_jarvis.main">main</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
